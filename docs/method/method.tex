\documentclass[letter]{article}

% Try to edit this document such that each sentence starts on its own
% line in order to help with git merge/diff/etc.
%  If you use Emacs, this will help:
% http://stackoverflow.com/questions/539984/


\usepackage{xspace}
\usepackage{bbm}                %Debian/Ubuntu package texlive-fonts-extra

\newcommand\fixme[1]{\textbf{FIXME:} \textit{#1}\xspace}

%% define some of the formal terms
\def\mQraw{Q^{\mathrm{raw}}_{t,i}}
\def\Qraw{$\mQraw$\xspace}

\def\mQdec{Q_{t,i}}
\def\Qdec{$\mQdec$\xspace}

\def\mQexp{Q^{\mathrm{exp}}_{t,i}}
\def\Qexp{$\mQexp$\xspace}

\def\mVcov{V_{t,ij}}
\def\Vcov{$\mVcov$\xspace}

\def\mAchc{A_{i\alpha}}
\def\Achc{$\mAchc$\xspace}

\def\mAchw{A^{\mathrm{chw}}_{ia}}
\def\Achw{$\mAchw$\xspace}

\def\mAwc{A^{\mathrm{wc}}_{a\alpha}}
\def\Awc{$\mAwc$\xspace}

\def\mQcell{Q^{\mathrm{cell}}_\alpha}
\def\Qcell{$\mQcell$\xspace}

\title{Wire Cell Method for LArTPC Reconstruction}
\author{Wire Cell Development Team\\Electronic Detector
  Group\\Physics Department\\Brookhaven National Lab\\(DRAFT, NOT FOR DISTRIBUTION)}

\begin{document}
\maketitle

\section{Overview}

\fixme{Section to be written to cover the following:}

\begin{itemize}
\item Brief description of the physics relevant to LAr TPC detectors
  with wire readout (ionization, drift, field, induction/collection,
  optical system to measure event time).
\item Brief description of the confounding aspects of LAr TPC
  (degeneracy of three 1D readouts of a 2D space, confounding
  ambiguity due to wire wrapping, the convoluted signal and detector
  response, what eles?)
\item Traditional approach.
\item Name this method: ``Wire Cell''
\item Briefly describe how it differs from traditional, reference
  section~\ref{sec:method} for details.
\end{itemize}

\section{Terms}

\fixme{This section should be removed for a real paper and the terms
  should be defined on first use.}

This section defines general and formal terms used in the document and
the software.
In conversation, please try to all use the same general terms.

\subsection{General Terms}

Specific terms used in this document and the software.

\begin{description}
\item[conductor] one contiguous run of a long thin conducting cylinder  
\item[wire] a single span of a \textit{conductor} strung across the drift
  volume perpendicular to the drift direction.
  AKA \textit{wire segment}.
  Some detectors may have multiple wires for any given single
  conductor due to wrapping the conductor around the wire frame.
\item[wire plane] a hypothetical plane containing all \textit{wires} which run
  parallel to each other.
  All three \textit{wire planes} are parallel.
\item[signal] voltage as a function of time on a \textit{conductor}
\item[channel] a connection of a \textit{conductor} to electronics
  which digitizes a voltage on the conductor as a function of time.
\item[deconvolution] the process by which a digitized \textit{signal} is
  transformed to remove the systematic effect of the
  induction/collection response and which may impart residual
  systematic smearing.
  (Currently this is performed external to this package.)
\item[charge] a measure of the \textit{signal} voltage integrated over
  some time bin.
\item[trace] representation of \textit{charge} and
  time information about a \textit{signal} after deconvolution.
  In general a \textit{trace} may represent part of an entire
  \textit{signal}.
  (Eg: zero-suppression or other thresholds can lead to multiple
  \texttt{traces} being associated to one channel when before there
  was but one.)
\item[cell] a region of the plane parallel to the \textit{wire planes}
  which is spatially associated with a number of \textit{wires} from
  each \textit{wire plane}.
\item[tiling] a collection of \textit{cells} which tile the plane.
\item[slice] a selection of a portion of each \textit{trace} in a
  collection of \textit{traces} which covers the same, contiguous
  region of their time bins.
\item[frame] a collection of \textit{traces} which are contiguous with
  respect to data acquisition, deconvolution and formation of
  \textit{slices} (aka a detector ``event'' or ``trigger'').
\end{description}

\subsection{Formal Terms}

These terms are used to formally describe the problem and have
analogues in the software.
Note, the vectors and matrices involved may very large ($10^4$ wires
and $10^7$ cells in a MicroBooNE geometry) so naive vector/matrix
representations are not used in the software.

\noindent The indices are chosen to indicate as in:
\begin{description}
\item[$t$] a time bin.
  This same indication is used be it a raw digitized time bin, a time
  bin after deconvolution or a possibly aggregate time bin produced by
  a slice.
\item[$a,b,c$] Latin indices in this range are used to enumerate \textit{wires}.
\item[$i,j,k$] Latin indices in this range are used to enumerate \textit{channels}.
\item[$\alpha,\beta$] Greek indices are used to enumerate \textit{cells}.
\end{description}

\noindent The formal terms used in this problem are:
\begin{description}
\item[\Qraw] the digitized \textit{charge} on channel $i$ at
  time bin $t$.
\item[\Qdec] the \textit{measured channel-charge vector} which gives the measured \textit{charge} on channel $i$ at
  time bin $t$ after deconvolution has been applied.
\item[\Qexp] an estimator or expected value of the above.
\item[\Vcov] a covariance matrix giving the 
  uncertainty in the \Qdec measurements at time $t$ between channels
  $i$ and $j$.
  This matrix is $n_\mathrm{channels}$-rows by $n_\mathrm{channels}$-columns.
\item[\Achc] the matrix representing the association between \textit{channels} and {cells}.
  It is a product of the following two matrices.
  This matrix is $n_\mathrm{channels}$-rows by $n_\mathrm{cells}$-columns.
\item[\Achw] the matrix representing the association between
  \textit{channels} and \textit{wires}.
  This matrix is $n_\mathrm{channels}$-rows by $n_\mathrm{wires}$-columns.
\item[\Awc] the matrix representing the association between
  \textit{wires} and \textit{cells}.
  This matrix is $n_\mathrm{wires}$-rows by $n_\mathrm{cells}$-columns.
\item[\Qcell] the \textit{cell-charge} vector representing the charge passing
  through a \texttt{cell} in a given time bin $t$.
\end{description}

\section{Method}

The goal of this method is to reconstruct the two dimensional pattern
of charge drifting through the wire planes at given time.
This section describes the general method employed to reach
this goal and some formalism describing its procedures.
Subsequent sections describe implementation and optimization details
which exploit an understanding of expected classes of LAr TPC event topology.

At a high level, the wire-cell method follows these broad steps:

\begin{enumerate}
\item Form a \textit{tiling} of \textit{cells} that associate \textit{channels} with a 2D
  region of nearly-crossing \textit{wires} (\Achc matrix)
\item Use information in the \textit{slice} to reduce the size of
  \Achc in a information-lossless manner.
\item Attempt to solve for the cells in terms of the channels (described below)
\item If initial solution fails, try a number of information-lossy
  methods to further reduce the size of \Achc (described below)
\end{enumerate}

\section{Tiling}

A hypothetical plane parallel to and approximately coplanar with the
\textit{wire planes} is partitioned into \textit{cells} via a tiling
process.
Initially, this tiling associates exactly one \textit{wire} from each
\textit{wire plane} with \textit{cell}.
Each wire-triplet is uniquely associated with exactly one cell and is
chosen such that the wires cross one another (typically pair-wise but
as a triplet in some geometries) nearer to each other than would any
other triplet if it were formed by replacing one of the wires with
another from the same plane.
Any triplets which fail this criteria do not form a cell.
This process fully tiles the plane without gaps or overlaps.
Algorithms for producing a tiling are described in section~\ref{subsec:tilingalg}.

It is noted that detectors which employ ``wire wrapping'' have an $N
\to 1$ mapping from \textit{channel} to \textit{wires}.
The solving for \textit{cells} described below require a ($N \to M$)
mapping from \textit{channels} to \textit{cells} and the tiling is
just one factor of that mapping.
The full mapping is the channel-cell matrix.

\begin{equation}
  \label{eq:Achc}
  \mAchc = \mAchw \mAwc
\end{equation}

For detectors with no wire wrapping $\mAchw \equiv \mathbbm{1}$.
Given knowledge of the charge in a cell at a given time one can write
the (deconvolved) charge expected to be measured in channel $i$ at
time $t$ as

\begin{equation}
  \label{eq:Qexp}
  \mQexp = \mAchc \mQcell.
\end{equation}

In the absence of uncertainties, the expected channel-charge vector
can be identified with the measured channel-charge vector and the
channel-cell matrix can be potentially inverted and thus one may solve
for the cell-charge vector.
However, there are two confounding problems to performing this
inversion which are described in
sections~\ref{subsec:tilingdegeneracy} and~\ref{subsec:chargeunc}.

\subsection{Tiling Algorithms}
\label{subsec:tilingalg}

\fixme{Michael, fill this in.}

\subsection{Tiling Degeneracy}
\label{subsec:tilingdegeneracy}

For realistic cases, it is not possible to invert the full
channel-cell matrix in because of its inherent degeneracy.
It maps approximately $3N$ ``knowns'' (channel measurements) to $N^2$
``unknowns'' (cells) where $N$ here is a number of order the number of
wires in one plane ($\sim 10^3$).
The size alone poses a practical problem due to system memory and CPU
usage.
Strategies to approach reducing the size of the channel-cell matrix
are described in section~\ref{sec:reduction}.
These procedures will either identify certain channels or cells which
may be removed from consideration or which may be effectively joined
or merged.

\subsection{Measurement Uncertainty}
\label{subsec:chargeunc}

The second problem that confounds inverting the channel-cell matrix,
even after it is reduced as above, is that this matrix alone does not
account for the uncertainty that exists in the measured charge.
This uncertainty is potentially covariant among the channels and thus
leads to an additional, effective mixing between channels and cells
beyond the multiplexing which is inherent in the definition of the
tiling.
The sources of measurement uncertainty fall into categories including
noise which may be correlated or uncorrelated between the channels and
residual smearing in time from the deconvolution process.

In order to incorporate this uncertainty the expected channel charge
vector (eqn~\ref{eq:Qexp}) is compared against its measured equivalent and 
a $\chi^2_t$ value is formed

\begin{equation}
  \label{eq:chi2}
  \chi^2_t(\mQcell) = (\mQdec - \mQexp)^\mathsf{T}\mVcov^{-1}(Q_{t,j} - Q^{\mathrm{exp}}_{t,j})
\end{equation}

\noindent Minimizing with respect to \Qcell gives,

\begin{equation}
  \label{eq:cellsolution}
  \mQcell = [(A^\mathsf{T}V_t^{-1}A)^{-1}]_{\alpha\beta}
  (A^\mathsf{T}V_t^{-1})_{\beta i}\mQdec
\end{equation}
Where indices internal to some of the matrix products have been
dropped for clarity.

\section{Channel-Cell Matrix Reduction}
\label{sec:reduction}

Again, in eqn~\ref{eq:cellsolution}, the Latin indices run over
channels and the Greek over cells.
One rough estimate of the number of cells to be defined in any given
detector is,
\begin{equation}
  \label{eq:ncellsestimate}
  N_\mathrm{cells} \approx N_\mathrm{wires}^2/9
\end{equation}

This ignores wire wrapping (increases number of cells per channel) and
assumes the same number of wires per plane and that the number of
cells can be estimated assuming every wire from one plane crosses
every wire from another plane and further that there is one cell per
crossing.
Table~\ref{tab:detectorcounts} gives channel counts and estimates for the
number of cells and the size of the full channel-cell matrix.

\begin{table}[htbp]
  \centering
  \begin{tabular}[h]{|r|r|l|l|}
    \hline
    Detector & \#channels & \#cells & $size(\mAchc)$ \\
    \hline
    \hline
    DUNE 35t APA & 512 & $3\times 10^4$ & $1\times 10^7$\\
    DUNE 10kt APA & 2560 & $7\times 10^5$ & $2\times 10^9$ \\
    MicroBooNE & 8256 & $7\times 10^6$ & $6\times 10^{10}$\\
    \hline
  \end{tabular}
  \caption{Channel counts and estimated number of cells of some LAr
    TPC detectors.
    In the case of DUNE detectors only one APA is considered.
    Activity that cross APA boundaries is left for future investigations.}
  \label{tab:detectorcounts}
\end{table}

In general, a reducing procedure maps an initial channel (cell) matrix
basis to another channel (cell) basis.
As described in the following two sections, reductions either preserve a subset of the
original basis (information-lossless or ``removal'') or produce a new basis which is some
linear combination of the original (information-lossy or ``merging'').
For both cases we represent the operation as a \textit{contraction} with
a matrix $R$ of the matrices or vectors in the original basis.
As an example, applying a cell reduction and inserting a wire
reduction to eqn~\ref{eq:Qexp} gives:

\begin{equation}
  \label{eq:contraction}
  R^\mathrm{ch} Q^\mathrm{exp}_t = 
R^\mathrm{ch} 
A (R^\mathrm{cell})^{-1} 
R^\mathrm{cell}  
Q^\mathrm{cell}
\end{equation}

It is then clear that the same formula is retained with the
substitution:

\begin{equation}
  \label{eq:subst}
  R^\mathrm{ch} A (R^\mathrm{cell})^{-1} \to A\\
\end{equation}
\begin{equation}
  \label{eq:subst2}
  R^\mathrm{x} Q^\mathrm{x} \to Q^\mathrm{x}
\end{equation}
Multiple reduction stages are represented by subsequent application of
a series of reduction matrices, each operating on the basis of the
previous producing a new, smaller basis.



\begin{equation}
  \label{eq:multipleR}
  R = R_1 R_2 R_3 ...
\end{equation}

\subsection{Lossless Reduction}

Some channels may not provide any contribution to the charge in a
given slice.
These channels may be removed in order to reduce the size of the
matrices in an information-lossless manner.
Such channels may come about due to the time bin for that channel failing to
satisfy zero-suppression (ZS) threshold applied during DAQ readout or
an analysis threshold applied offline.
To exploit the reduction this allows, with not loss of information,
one considers a \textit{reduced} channel-cell matrix
$A'_{i\alpha}$ which is made of only those associations
between the channels above threshold and only those cells which can be
formed with valid triplets of wires associated with this reduced set of
channels.

\subsection{Lossy Reduction}

If the slice can not be solved after lossless reduction, further
reduction can be attempted which is information-lossy in nature.


\subsubsection{Merging}

One lossy reduction takes the form of merging channels or cells based on
some desiderata.
When two neighboring cells are merged, one or two of their wires may be in common.
This leads to a reduction in both the number of rows and columns in
producing a further reduced channel-cell matrix $A''_{i\alpha}$.

\subsubsection{Inter-slice Interpolation}

Another approach is to delay solving a slice until solutions are
achieved for the two slices which
bracket in time the unsolved one.
With the pair of solved slices in hand one may apply some inter-slice
interpolation for cells found problematic, remove their contribution
from the associated wires and attempt to re-solve.
Or, one may perform a $\chi^2$ fit using eqn~\ref{eq:chi2} using the
bracketing slices to direct the search space. 

\end{document}
